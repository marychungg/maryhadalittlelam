<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>毛毛排班月曆</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background-color: #fff8f0;
            padding: 15px;
            min-height: 100vh;
        }
        /* 頁面切換按鈕 - 改為3個（排班+班次+地點） */
        .page-tabs {
            max-width: 600px;
            margin: 0 auto 15px;
            display: flex;
            gap: 8px;
        }
        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            background: #ffb74d;
            color: white;
        }
        .tab-btn.active {
            background: #8c6d53;
            box-shadow: 0 2px 8px rgba(255,167,38,0.3);
        }
        .tab-btn:hover {
            background: #8c6d53;
        }
        /* 通用容器 */
        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            overflow: hidden;
            max-width: 600px;
            margin: 0 auto;
            display: none;
        }
        .container.active {
            display: block;
        }
        /* 月曆頁面樣式 - 核心不溢出 */
        .calendar-header {
            background-color: #ffb74d;
            color: white;
            padding: 18px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .month-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            justify-content: center;
        }
        .month-selector button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .month-selector button:hover {
            background: rgba(255,255,255,0.3);
        }
        .month-title {
            font-size: 19px;
            font-weight: bold;
            text-align: center;
            margin: 0 10px;
        }
        .year-select {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 8px;
            border-radius: 6px;
            font-size: 13px;
            outline: none;
        }
        .year-select option {
            color: #333;
        }
        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background-color: #fff3e0;
            border-bottom: 1px solid #ffe0b2;
        }
        .weekday {
            padding: 8px 0;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: #f57c00;
        }
        .weekday.sun {
            color: #e53935; /* 周日紅色 */
        }
        /* 日期容器 - 固定高度不溢出 */
        .days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            padding: 10px;
            grid-auto-rows: 95px;
        }
        /* 日期框 - 極致壓縮間距 */
        .day {
            border-radius: 8px;
            padding: 4px 3px;
            border: 1px solid #ffe0b2;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            gap: 2px;
            background: #fff8f0;
            overflow: hidden;
        }
        /* 時段配色 */
        .day.bg-holiday { background: #f5e9d7; border-color: #e8d4b9; }
        .day.bg-morning { background: #fce4ec; border-color: #f8bbd0; }
        .day.bg-noon { background: #e8d9c8; border-color: #d2b48c; }
        .day.bg-night { background: #e3eaf5; border-color: #bdd0eb; }
        .day.bg-other { background: #e8f5e9; border-color: #c8e6c9; }
        .day:hover {
            border-color: #ffb74d;
            transform: translateY(-1px);
        }
        .day.empty {
            background: transparent;
            border: none;
        }
        .day.expired {
            background: #f5f5f5 !important;
            border-color: #e0e0e0 !important;
            opacity: 0.6;
            pointer-events: none;
            overflow: hidden;
        }
        .date {
            font-size: 13px;
            font-weight: bold;
            color: #f57c00;
            text-align: center;
            line-height: 1;
            flex-shrink: 0;
            height: 16px;
        }
        .shift-select {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 2px 1px;
            text-align: center;
            font-size: 11px;
            background: rgba(255,255,255,0.9);
            transition: all 0.2s;
            outline: none;
            color: #333;
            flex-shrink: 0;
            height: 20px;
        }
        .shift-select:focus {
            border-color: #ffb74d;
            background: #fff;
        }
        /* 班次信息 */
        .shift-info {
            font-size: 9px;
            color: #333;
            text-align: center;
            line-height: 1.2;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 1px;
            word-wrap: break-word;
            white-space: normal;
        }
        .s-code {
            font-weight: 700;
            font-size: 10px;
        }
        .s-code.blue {
            color: blue !important;
        }
        .s-time {
            font-weight: 400;
        }
        /* 地點按鈕 - 核心：預設白色底KT，點擊橙色底TST（無重複） */
        .loc-btn {
            width: 100%;
            padding: 1px 0;
            border: 1px solid #ff9800;
            border-radius: 3px;
            font-size: 9px;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            height: 16px;
            /* 預設樣式：白色底+KT字樣 */
            background: #fff;
            color: #ff9800;
        }
        /* 激活樣式：橙色底+TST字樣 */
        .loc-btn.active {
            background: #ff9800;
            color: white;
        }
        /* 按鈕通用樣式 */
        .btn-save {
            display: block;
            width: 90%;
            margin: 15px auto 20px;
            padding: 12px;
            background: #ffb74d;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn-save:hover {
            background: #8c6d53;
        }
        /* 班次管理頁面 - 不變 */
        .manage-header {
            background-color: #ffb74d;
            color: white;
            padding: 20px 15px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
        }
        .manage-form {
            padding: 20px 15px;
            border-bottom: 1px solid #ffe0b2;
            display: grid;
            gap: 15px;
            grid-template-columns: 1fr 1fr;
        }
        .manage-form .form-item {
            grid-column: span 2;
        }
        .manage-form .color-item {
            grid-column: span 2;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .form-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .form-item label, .color-item label {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }
        .form-input, .color-select {
            padding: 10px;
            border: 1px solid #ffe0b2;
            border-radius: 8px;
            outline: none;
            font-size: 14px;
            color: #333;
        }
        .form-input:focus, .color-select:focus {
            border-color: #ffb74d;
        }
        .btn-add {
            grid-column: span 2;
            padding: 12px;
            background: #ffb74d;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn-add:hover {
            background: #8c6d53;
        }
        .shift-list, .location-list {
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        .shift-item, .location-item {
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 10px;
            min-height: 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            border: 1px solid #eee;
        }
        .shift-item.bg-holiday { background: #f5e9d7; border-color: #e8d4b9; }
        .shift-item.bg-morning { background: #fce4ec; border-color: #f8bbd0; }
        .shift-item.bg-noon { background: #e8d9c8; border-color: #d2b48c; }
        .shift-item.bg-night { background: #e3eaf5; border-color: #bdd0eb; }
        .shift-item.bg-other { background: #e8f5e9; border-color: #c8e6c9; }
        .shift-item-info, .location-item-info {
            display: flex;
            flex-direction: column;
            gap: 3px;
            align-items: flex-start;
            flex-grow: 1;
        }
        .shift-item-code, .location-item-code {
            font-size: 16px;
            font-weight: 700;
            color: #333;
        }
        .shift-item-time, .location-item-desc {
            font-size: 13px;
            color: #666;
        }
        .shift-item-color {
            font-size: 12px;
            color: #888;
        }
        .shift-actions, .location-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }
        .btn-edit, .btn-delete, .loc-btn-edit, .loc-btn-delete {
            padding: 5px 10px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-edit, .loc-btn-edit {
            background: #e3f2fd;
            color: #2196f3;
        }
        .btn-edit:hover, .loc-btn-edit:hover {
            background: #bbdefb;
        }
        .btn-delete, .loc-btn-delete {
            background: #ffebee;
            color: #e53935;
        }
        .btn-delete:hover, .loc-btn-delete:hover {
            background: #ffcdd2;
        }
        .btn-save-shifts, .btn-save-locations {
            margin: 15px;
        }
        /* 地點管理頁面獨有樣式 */
        .location-item.active-loc {
            border-left: 4px solid #ff9800;
            background: #fff8f0;
        }
        /* 手機小屏適配 */
        @media (max-width: 450px) {
            .days {
                gap: 4px;
                padding: 8px;
                grid-auto-rows: 90px;
            }
            .day {
                padding: 3px 2px;
                gap: 1px;
            }
            .date {
                font-size: 12px;
                height: 14px;
            }
            .shift-select {
                font-size: 10px;
                height: 18px;
            }
            .shift-info {
                font-size: 8.5px;
            }
            .s-code {
                font-size: 9px;
            }
            .loc-btn {
                font-size: 8px;
                height: 14px;
            }
            .tab-btn {
                font-size: 14px;
                padding: 8px;
            }
        }
        @media (max-width: 380px) {
            .days {
                grid-auto-rows: 85px;
            }
            .shift-info {
                font-size: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- 頁面切換按鈕 - 新增地點管理 -->
    <div class="page-tabs">
        <button class="tab-btn active" data-tab="calendar">排班月曆</button>
        <button class="tab-btn" data-tab="shift-manage">班次管理</button>
        <button class="tab-btn" data-tab="location-manage">地點管理</button>
    </div>

    <!-- 排班月曆頁面 -->
    <div class="container active" id="calendar">
        <div class="calendar-header">
            <div class="month-selector">
                <button id="prev-month">&lt;</button>
                <div class="month-title" id="month-title">2026年2月</div>
                <button id="next-month">&gt;</button>
            </div>
            <select id="year-select" class="year-select">
                <option value="2025">2025</option>
                <option value="2026" selected>2026</option>
                <option value="2027">2027</option>
            </select>
        </div>
        <div class="weekdays">
            <div class="weekday sun">日</div>
            <div class="weekday">一</div>
            <div class="weekday">二</div>
            <div class="weekday">三</div>
            <div class="weekday">四</div>
            <div class="weekday">五</div>
            <div class="weekday">六</div>
        </div>
        <div class="days" id="days-container"></div>
        <button class="btn-save" id="save-calendar">儲存本月排班</button>
    </div>

    <!-- 班次管理頁面 - 原manage改名 -->
    <div class="container" id="shift-manage">
        <div class="manage-header">班次管理 | 新增/編輯/刪除</div>
        <form class="manage-form" id="shift-form">
            <div class="form-item">
                <label for="shift-code">班次程式（如D11H、L）</label>
                <input type="text" id="shift-code" class="form-input" placeholder="請輸入班次程式" required>
            </div>
            <div class="form-item">
                <label for="shift-time">上下班時間（如11:30 - 19:00、放假）</label>
                <input type="text" id="shift-time" class="form-input" placeholder="請輸入時間/備註" required>
            </div>
            <div class="color-item">
                <label for="shift-color">選擇班次配色</label>
                <select id="shift-color" class="color-select" required>
                    <option value="" selected disabled>請選擇配色</option>
                    <option value="holiday">放假 - 淺啡色</option>
                    <option value="morning">早更 - 粉紅色</option>
                    <option value="noon">午間 - 深啡色</option>
                    <option value="night">晚更 - 深藍色</option>
                    <option value="other">其他 - 淺綠色</option>
                </select>
            </div>
            <button type="submit" class="btn-add" id="btn-add-shift">新增班次</button>
        </form>
        <div class="shift-list" id="shift-list"></div>
        <button class="btn-save btn-save-shifts" id="save-shifts">儲存所有班次</button>
    </div>

    <!-- 新增：地點管理頁面（默認KT，支援增刪改） -->
    <div class="container" id="location-manage">
        <div class="manage-header">地點管理 | 新增/編輯/刪除（默認KT）</div>
        <form class="manage-form" id="location-form">
            <div class="form-item">
                <label for="location-code">地點簡寫（如KT、TST）</label>
                <input type="text" id="location-code" class="form-input" placeholder="請輸入地點簡寫（2-3個字）" required>
            </div>
            <div class="form-item">
                <label for="location-desc">地點全名（如啟德、尖沙咀）</label>
                <input type="text" id="location-desc" class="form-input" placeholder="請輸入地點全名" required>
            </div>
            <button type="submit" class="btn-add" id="btn-add-location">新增地點</button>
        </form>
        <div class="location-list" id="location-list"></div>
        <button class="btn-save btn-save-locations" id="save-locations">儲存所有地點</button>
    </div>

    <script>
        // 全局變量
        let currentYear = 2026;
        let currentMonth = 1;
        const today = new Date();
        const todayYear = today.getFullYear();
        const todayMonth = today.getMonth();
        const todayDate = today.getDate();
        let shiftTimes = {}; // 班次數據
        let locations = {};  // 地點數據 {代碼: 全名}
        let editShiftCode = null; // 編輯班次標記
        let editLocCode = null;   // 編輯地點標記

        // 頁面初始化
        function initApp() {
            const today = new Date();
            currentYear = today.getFullYear();
            currentMonth = today.getMonth();

            // 加載班次數據
            const savedShifts = localStorage.getItem('shiftTimes');
            if (savedShifts) {
                shiftTimes = JSON.parse(savedShifts);
            } else {
                // 默認班次
                shiftTimes = {
                    "B**": {time: "06:00 - 15:30", color: "morning"},
                    "B6": {time: "06:00 - 13:30", color: "morning"},
                    "B": {time: "07:00 - 15:30", color: "morning"},
                    "B7": {time: "07:00 - 14:30", color: "morning"},
                    "B8": {time: "08:00 - 15:30", color: "morning"},
                    "B8H": {time: "08:30 - 16:00", color: "morning"},
                    "BB": {time: "06:00 - 15:30", color: "morning"},
                    "K/DD": {time: "08:45 - 17:33", color: "noon"},
                    "D845": {time: "08:45 - 16:15", color: "noon"},
                    "D8H": {time: "08:30 - 16:00", color: "noon"},
                    "D9": {time: "09:00 - 16:30", color: "noon"},
                    "D9H": {time: "09:30 - 17:00", color: "noon"},
                    "D10": {time: "10:00 - 17:30", color: "noon"},
                    "D10H": {time: "10:30 - 18:00", color: "noon"},
                    "D11": {time: "11:00 - 18:30", color: "noon"},
                    "D11H": {time: "11:30 - 19:00", color: "noon"},
                    "D12": {time: "12:00 - 19:30", color: "noon"},
                    "D12H": {time: "12:30 - 20:00", color: "noon"},
                    "E": {time: "14:30 - 23:00", color: "night"},
                    "E**": {time: "14:30 - 24:00", color: "night"},
                    "E1": {time: "13:00 - 20:30", color: "night"},
                    "E1H": {time: "13:30 - 21:00", color: "night"},
                    "E2": {time: "14:00 - 21:30", color: "night"},
                    "E2H": {time: "14:30 - 22:00", color: "night"},
                    "E3": {time: "15:00 - 22:30", color: "night"},
                    "E3H": {time: "15:30 - 23:00", color: "night"},
                    "E4": {time: "16:00 - 23:30", color: "night"},
                    "E4H": {time: "16:30 - 24:00", color: "night"},
                    "EE": {time: "14:30 - 23:00", color: "night"},
                    "L": {time: "放假", color: "holiday"},
                    "KCTA": {time: "23:00 - 07:30", color: "other"},
                };
            }

            // 加載地點數據 - 默認KT（觀塘）
            const savedLocs = localStorage.getItem('locations');
            if (savedLocs) {
                locations = JSON.parse(savedLocs);
            } else {
                locations = {
                    "KT": "啟德",
                    "TST": "尖沙咀"
                };
            }

            // 渲染所有模塊
            renderCalendar(currentYear, currentMonth);
            renderShiftList();
            renderLocationList();
        }

        // 頁面切換（支援3個頁面）
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const tab = btn.dataset.tab;
                document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
                document.getElementById(tab).classList.add('active');
                if (tab === 'calendar') renderCalendar(currentYear, currentMonth);
            });
        });

        // 渲染月曆 - 核心：地點按鈕預設KT，點擊切換TST（無重複）
        function renderCalendar(year, month) {
            const daysContainer = document.getElementById('days-container');
            daysContainer.innerHTML = '';

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // 填充上月空白格
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.classList.add('day', 'empty');
                daysContainer.appendChild(emptyDay);
            }

            // 班次排序
            const sortedShiftCodes = Object.keys(shiftTimes).sort((a, b) => a.localeCompare(b, 'zh-CN', { numeric: true }));
            let shiftOptions = '<option value="" selected disabled></option>';
            sortedShiftCodes.forEach(shift => {
                shiftOptions += `<option value="${shift}">${shift}</option>`;
            });

            // 加載保存的排班和地點狀態
            const saveKey = `shift_${year}-${month + 1}`;
            const savedCalendar = localStorage.getItem(saveKey);
            const calendarData = savedCalendar ? JSON.parse(savedCalendar) : {};

            // 填充當月日期
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.classList.add('day');
                // 過期判斷
                const isExpired = (year < todayYear) || 
                                  (year === todayYear && month < todayMonth) || 
                                  (year === todayYear && month === todayMonth && day < todayDate);
                if (isExpired) dayEl.classList.add('expired');

                // 核心DOM：移除重複TST，僅一個地點按鈕（預設KT）
                dayEl.innerHTML = `
                    <div class="date">${day}</div>
                    <select class="shift-select">${shiftOptions}</select>
                    <div class="shift-info"></div>
                    <button class="loc-btn">KT</button> <!-- 預設白色底KT -->
                `;
                daysContainer.appendChild(dayEl);

                // 加載保存的班次+地點狀態
                if (calendarData[day]) {
                    const { shiftCode, locCode } = calendarData[day];
                    const select = dayEl.querySelector('.shift-select');
                    const infoEl = dayEl.querySelector('.shift-info');
                    const locBtn = dayEl.querySelector('.loc-btn');
                    
                    // 加載班次
                    if (shiftCode) {
                        select.value = shiftCode;
                        const {time, color} = shiftTimes[shiftCode];
                        dayEl.classList.add(`bg-${color}`);
                        const codeClass = (shiftCode === 'BB' || shiftCode === 'EE') ? 's-code blue' : 's-code';
                        infoEl.innerHTML = `
                            <span class="${codeClass}">${shiftCode}</span>
                            <span class="s-time">${time}</span>
                        `;
                    }

                    // 加載地點狀態：如果是TST則激活（橙色底TST）
                    if (locCode === 'TST') {
                        locBtn.classList.add('active');
                        locBtn.textContent = 'TST';
                    }
                }

                // 綁定班次選擇事件
                dayEl.querySelector('.shift-select').addEventListener('change', updateShiftInfo);
                // 綁定地點按鈕事件：點擊切換KT/TST（無重複，只改文字和樣式）
                dayEl.querySelector('.loc-btn').addEventListener('click', function() {
                    this.classList.toggle('active');
                    if (this.classList.contains('active')) {
                        this.textContent = 'TST'; // 激活：橙色底TST
                    } else {
                        this.textContent = 'KT';  // 默認：白色底KT
                    }
                });
            }

            // 更新標題
            document.getElementById('month-title').textContent = `${year}年${month + 1}月`;
            document.getElementById('year-select').value = year;
        }

        // 更新班次信息
        function updateShiftInfo() {
            const code = this.value;
            const infoEl = this.nextElementSibling;
            const dayEl = this.parentElement;
            dayEl.classList.remove('bg-holiday', 'bg-morning', 'bg-noon', 'bg-night', 'bg-other');

            if (!code) {
                infoEl.innerHTML = '';
                return;
            }
            const {time, color} = shiftTimes[code];
            dayEl.classList.add(`bg-${color}`);
            const codeClass = (code === 'BB' || code === 'EE') ? 's-code blue' : 's-code';
            infoEl.innerHTML = `
                <span class="${codeClass}">${code}</span>
                <span class="s-time">${time}</span>
            `;
        }

        // 月份/年份切換
        document.getElementById('prev-month').addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar(currentYear, currentMonth);
        });
        document.getElementById('next-month').addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar(currentYear, currentMonth);
        });
        document.getElementById('year-select').addEventListener('change', (e) => {
            currentYear = parseInt(e.target.value);
            renderCalendar(currentYear, currentMonth);
        });

        // 保存本月排班+地點狀態（存locCode：KT/TST）
        document.getElementById('save-calendar').addEventListener('click', () => {
            const saveKey = `${currentYear}-${currentMonth + 1}`;
            const saveData = {};
            document.querySelectorAll('.day').forEach(dayEl => {
                const date = dayEl.querySelector('.date')?.textContent;
                const shiftCode = dayEl.querySelector('.shift-select')?.value;
                const locBtn = dayEl.querySelector('.loc-btn');
                // 獲取當前地點代碼：激活=TST，否則=KT
                const locCode = locBtn.classList.contains('active') ? 'TST' : 'KT';
                if (date) {
                    saveData[date] = { shiftCode, locCode };
                }
            });
            localStorage.setItem(`shift_${saveKey}`, JSON.stringify(saveData));
            alert("✅ 本月排班+地點已儲存！");
        });

        // ---------------------- 班次管理相關 ----------------------
        function renderShiftList() {
            const listContainer = document.getElementById('shift-list');
            listContainer.innerHTML = '';
            const sortedShifts = Object.entries(shiftTimes).sort((a, b) => a[0].localeCompare(b, 'zh-CN', { numeric: true }));
            const colorName = {
                holiday: '放假-淺啡',
                morning: '早更-粉紅',
                noon: '午間-深啡',
                night: '晚更-深藍',
                other: '其他-淺綠'
            };
            sortedShifts.forEach(([code, {time, color}]) => {
                const item = document.createElement('div');
                item.className = `shift-item bg-${color}`;
                item.dataset.code = code;
                item.innerHTML = `
                    <div class="shift-item-info">
                        <span class="shift-item-code">${code}</span>
                        <span class="shift-item-time">${time}</span>
                        <span class="shift-item-color">配色：${colorName[color]}</span>
                    </div>
                    <div class="shift-actions">
                        <button class="btn-edit" data-code="${code}">編輯</button>
                        <button class="btn-delete" data-code="${code}">刪除</button>
                    </div>
                `;
                listContainer.appendChild(item);
            });
            bindShiftActions();
        }

        function bindShiftActions() {
            document.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const code = e.target.dataset.code;
                    const {time, color} = shiftTimes[code];
                    editShiftCode = code;
                    document.getElementById('shift-code').value = code;
                    document.getElementById('shift-time').value = time;
                    document.getElementById('shift-color').value = color;
                    document.getElementById('btn-add-shift').textContent = '保存編輯';
                });
            });
            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const code = e.target.dataset.code;
                    if (confirm(`確定要刪除班次【${code}】嗎？`)) {
                        delete shiftTimes[code];
                        renderShiftList();
                    }
                });
            });
        }

        document.getElementById('shift-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const code = document.getElementById('shift-code').value.trim();
            const time = document.getElementById('shift-time').value.trim();
            const color = document.getElementById('shift-color').value;
            if (!code || !time || !color) return;

            if (editShiftCode) {
                delete shiftTimes[editShiftCode];
                shiftTimes[code] = {time, color};
                editShiftCode = null;
                document.getElementById('btn-add-shift').textContent = '新增班次';
                alert(`✅ 班次【${code}】已編輯！`);
            } else {
                if (shiftTimes[code]) {
                    alert(`⚠️ 班次【${code}】已存在！`);
                    return;
                }
                shiftTimes[code] = {time, color};
                alert(`✅ 班次【${code}】已新增！`);
            }
            document.getElementById('shift-form').reset();
            renderShiftList();
        });

        document.getElementById('save-shifts').addEventListener('click', () => {
            localStorage.setItem('shiftTimes', JSON.stringify(shiftTimes));
            alert("✅ 所有班次已儲存到本地！");
        });

        // ---------------------- 新增：地點管理相關 ----------------------
        function renderLocationList() {
            const listContainer = document.getElementById('location-list');
            listContainer.innerHTML = '';
            const sortedLocs = Object.entries(locations).sort((a, b) => a[0].localeCompare(b));
            sortedLocs.forEach(([code, desc]) => {
                const item = document.createElement('div');
                // 默認KT標記為默認地點
                item.className = `location-item ${code === 'KT' ? 'active-loc' : ''}`;
                item.dataset.code = code;
                item.innerHTML = `
                    <div class="location-item-info">
                        <span class="location-item-code">${code}</span>
                        <span class="location-item-desc">${desc}</span>
                        ${code === 'KT' ? '<span style="font-size:12px;color:#ff9800;">默認地點</span>' : ''}
                    </div>
                    <div class="location-actions">
                        <button class="loc-btn-edit" data-code="${code}">編輯</button>
                        <button class="loc-btn-delete" data-code="${code}">刪除</button>
                    </div>
                `;
                // KT不可刪除
                if (code === 'KT') {
                    item.querySelector('.loc-btn-delete').disabled = true;
                    item.querySelector('.loc-btn-delete').style.opacity = 0.5;
                    item.querySelector('.loc-btn-delete').style.cursor = 'not-allowed';
                }
                listContainer.appendChild(item);
            });
            bindLocationActions();
        }

        function bindLocationActions() {
            // 編輯地點
            document.querySelectorAll('.loc-btn-edit').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const code = e.target.dataset.code;
                    const desc = locations[code];
                    editLocCode = code;
                    document.getElementById('location-code').value = code;
                    document.getElementById('location-desc').value = desc;
                    document.getElementById('btn-add-location').textContent = '保存編輯';
                });
            });
            // 刪除地點（KT不可刪）
            document.querySelectorAll('.loc-btn-delete').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const code = e.target.dataset.code;
                    if (code === 'KT') return;
                    if (confirm(`確定要刪除地點【${code} - ${locations[code]}】嗎？`)) {
                        delete locations[code];
                        renderLocationList();
                    }
                });
            });
        }

        // 新增/編輯地點
        document.getElementById('location-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const code = document.getElementById('location-code').value.trim().toUpperCase();
            const desc = document.getElementById('location-desc').value.trim();
            if (!code || !desc || code.length > 3) {
                alert('⚠️ 地點簡寫請輸入2-3個字，全名不可為空！');
                return;
            }

            if (editLocCode) {
                // 編輯：KT不可改簡寫
                if (editLocCode === 'KT' && code !== 'KT') {
                    alert('⚠️ 默認地點KT的簡寫不可修改！');
                    return;
                }
                delete locations[editLocCode];
                locations[code] = desc;
                editLocCode = null;
                document.getElementById('btn-add-location').textContent = '新增地點';
                alert(`✅ 地點【${code}】已編輯！`);
            } else {
                if (locations[code]) {
                    alert(`⚠️ 地點【${code}】已存在！`);
                    return;
                }
                locations[code] = desc;
                alert(`✅ 地點【${code}】已新增！`);
            }
            document.getElementById('location-form').reset();
            renderLocationList();
        });

        // 保存所有地點
        document.getElementById('save-locations').addEventListener('click', () => {
            localStorage.setItem('locations', JSON.stringify(locations));
            alert("✅ 所有地點已儲存到本地！");
        });

        // 初始化應用
        window.onload = initApp;
    </script>
</body>
</html>
