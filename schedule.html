<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>æ¯›æ¯›æ’ç­æœˆæ›†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background-color: #fff8f0;
            padding: 15px;
            min-height: 100vh;
        }
        /* é é¢åˆ‡æ›æŒ‰éˆ• - 3å€‹ï¼ˆæ’ç­+ç­æ¬¡+åœ°é»ï¼‰ */
        .page-tabs {
            max-width: 600px;
            margin: 0 auto 15px;
            display: flex;
            gap: 8px;
        }
        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            background: #ffb74d;
            color: white;
        }
        .tab-btn.active {
            background: #8c6d53;
            box-shadow: 0 2px 8px rgba(255,167,38,0.3);
        }
        .tab-btn:hover {
            background: #8c6d53;
        }
        /* é€šç”¨å®¹å™¨ */
        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            overflow: hidden;
            max-width: 600px;
            margin: 0 auto;
            display: none;
        }
        .container.active {
            display: block;
        }
        /* æœˆæ›†é é¢æ¨£å¼ - æ ¸å¿ƒä¸æº¢å‡º */
        .calendar-header {
            background-color: #ffb74d;
            color: white;
            padding: 18px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .month-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            justify-content: center;
        }
        .month-selector button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .month-selector button:hover {
            background: rgba(255,255,255,0.3);
        }
        .month-title {
            font-size: 19px;
            font-weight: bold;
            text-align: center;
            margin: 0 10px;
        }
        .year-select {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 8px;
            border-radius: 6px;
            font-size: 13px;
            outline: none;
        }
        .year-select option {
            color: #333;
        }
        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background-color: #fff3e0;
            border-bottom: 1px solid #ffe0b2;
        }
        .weekday {
            padding: 8px 0;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: #f57c00;
        }
        .weekday.sun {
            color: #e53935; /* å‘¨æ—¥ç´…è‰² */
        }
        /* æ—¥æœŸå®¹å™¨ - å›ºå®šé«˜åº¦ä¸æº¢å‡º */
        .days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            padding: 10px;
            grid-auto-rows: 95px;
        }
        /* æ—¥æœŸæ¡† - æ¥µè‡´å£“ç¸®é–“è· */
        .day {
            border-radius: 8px;
            padding: 4px 3px;
            border: 1px solid #ffe0b2;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            gap: 2px;
            background: #fff8f0;
            overflow: hidden;
        }
        /* æ™‚æ®µé…è‰² */
        .day.bg-holiday { background: #f5e9d7; border-color: #e8d4b9; }
        .day.bg-morning { background: #fce4ec; border-color: #f8bbd0; }
        .day.bg-noon { background: #e8d9c8; border-color: #d2b48c; }
        .day.bg-night { background: #e3eaf5; border-color: #bdd0eb; }
        .day.bg-other { background: #e8f5e9; border-color: #c8e6c9; }
        .day:hover {
            border-color: #ffb74d;
            transform: translateY(-1px);
        }
        .day.empty {
            background: transparent;
            border: none;
        }
        .day.expired {
            background: #f5f5f5 !important;
            border-color: #e0e0e0 !important;
            opacity: 0.6;
            pointer-events: none;
            overflow: hidden;
        }
        .date {
            font-size: 13px;
            font-weight: bold;
            color: #f57c00;
            text-align: center;
            line-height: 1;
            flex-shrink: 0;
            height: 16px;
        }
        .shift-select {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 2px 1px;
            text-align: center;
            font-size: 11px;
            background: rgba(255,255,255,0.9);
            transition: all 0.2s;
            outline: none;
            color: #333;
            flex-shrink: 0;
            height: 20px;
        }
        .shift-select:focus {
            border-color: #ffb74d;
            background: #fff;
        }
        /* ç­æ¬¡ä¿¡æ¯ */
        .shift-info {
            font-size: 9px;
            color: #333;
            text-align: center;
            line-height: 1.2;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 1px;
            word-wrap: break-word;
            white-space: normal;
        }
        .s-code {
            font-weight: 700;
            font-size: 10px;
        }
        .s-code.blue {
            color: blue !important;
        }
        .s-time {
            font-weight: 400;
        }
        /* åœ°é»æŒ‰éˆ• - æ ¸å¿ƒï¼šé è¨­ç™½è‰²åº•KTï¼Œé»æ“Šæ©™è‰²åº•TSTï¼ˆç„¡é‡è¤‡ï¼‰ */
        .loc-btn {
            width: 100%;
            padding: 1px 0;
            border: 1px solid #ff9800;
            border-radius: 3px;
            font-size: 9px;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            height: 16px;
            /* é è¨­æ¨£å¼ï¼šç™½è‰²åº•+KTå­—æ¨£ */
            background: #fff;
            color: #ff9800;
        }
        /* æ¿€æ´»æ¨£å¼ï¼šæ©™è‰²åº•+TSTå­—æ¨£ */
        .loc-btn.active {
            background: #ff9800;
            color: white;
        }
        /* æŒ‰éˆ•é€šç”¨æ¨£å¼ */
        .btn-save {
            display: block;
            width: 90%;
            margin: 15px auto 20px;
            padding: 12px;
            background: #ffb74d;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn-save:hover {
            background: #8c6d53;
        }
        /* ç­æ¬¡/åœ°é»ç®¡ç†é é¢é€šç”¨æ¨£å¼ */
        .manage-header {
            background-color: #ffb74d;
            color: white;
            padding: 20px 15px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
        }
        .manage-form {
            padding: 20px 15px;
            border-bottom: 1px solid #ffe0b2;
            display: grid;
            gap: 15px;
            grid-template-columns: 1fr 1fr;
        }
        .manage-form .form-item {
            grid-column: span 2;
        }
        .form-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .form-item label {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }
        .form-input {
            padding: 10px;
            border: 1px solid #ffe0b2;
            border-radius: 8px;
            outline: none;
            font-size: 14px;
            color: #333;
        }
        .form-input:focus {
            border-color: #ffb74d;
        }
        .btn-add {
            grid-column: span 2;
            padding: 12px;
            background: #ffb74d;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn-add:hover {
            background: #8c6d53;
        }
        .shift-list, .location-list {
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        .shift-item, .location-item {
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 10px;
            min-height: 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            border: 1px solid #eee;
        }
        .shift-item.bg-holiday { background: #f5e9d7; border-color: #e8d4b9; }
        .shift-item.bg-morning { background: #fce4ec; border-color: #f8bbd0; }
        .shift-item.bg-noon { background: #e8d9c8; border-color: #d2b48c; }
        .shift-item.bg-night { background: #e3eaf5; border-color: #bdd0eb; }
        .shift-item.bg-other { background: #e8f5e9; border-color: #c8e6c9; }
        .shift-item-info, .location-item-info {
            display: flex;
            flex-direction: column;
            gap: 3px;
            align-items: flex-start;
            flex-grow: 1;
        }
        .shift-item-code, .location-item-code {
            font-size: 16px;
            font-weight: 700;
            color: #333;
        }
        .shift-item-time, .location-item-desc {
            font-size: 13px;
            color: #666;
        }
        .shift-item-color {
            font-size: 12px;
            color: #888;
        }
        .shift-actions, .location-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }
        .btn-edit, .btn-delete, .loc-btn-edit, .loc-btn-delete {
            padding: 5px 10px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-edit, .loc-btn-edit {
            background: #e3f2fd;
            color: #2196f3;
        }
        .btn-edit:hover, .loc-btn-edit:hover {
            background: #bbdefb;
        }
        .btn-delete, .loc-btn-delete {
            background: #ffebee;
            color: #e53935;
        }
        .btn-delete:hover, .loc-btn-delete:hover {
            background: #ffcdd2;
        }
        .btn-save-shifts, .btn-save-locations {
            margin: 15px;
        }
        /* åœ°é»ç®¡ç†ç¨æœ‰æ¨£å¼ */
        .location-item.active-loc {
            border-left: 4px solid #ff9800;
            background: #fff8f0;
        }
        /* æ‰‹æ©Ÿå°å±é©é… */
        @media (max-width: 450px) {
            .days {
                gap: 4px;
                padding: 8px;
                grid-auto-rows: 90px;
            }
            .day {
                padding: 3px 2px;
                gap: 1px;
            }
            .date {
                font-size: 12px;
                height: 14px;
            }
            .shift-select {
                font-size: 10px;
                height: 18px;
            }
            .shift-info {
                font-size: 8.5px;
            }
            .s-code {
                font-size: 9px;
            }
            .loc-btn {
                font-size: 8px;
                height: 14px;
            }
            .tab-btn {
                font-size: 14px;
                padding: 8px;
            }
        }
        @media (max-width: 380px) {
            .days {
                grid-auto-rows: 85px;
            }
            .shift-info {
                font-size: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- é é¢åˆ‡æ›æŒ‰éˆ• -->
    <div class="page-tabs">
        <button class="tab-btn active" data-tab="calendar">æ’ç­æœˆæ›†</button>
        <button class="tab-btn" data-tab="shift-manage">ç­æ¬¡ç®¡ç†</button>
        <button class="tab-btn" data-tab="location-manage">åœ°é»ç®¡ç†</button>
    </div>

    <!-- æ’ç­æœˆæ›†é é¢ -->
    <div class="container active" id="calendar">
        <div class="calendar-header">
            <div class="month-selector">
                <button id="prev-month">&lt;</button>
                <div class="month-title" id="month-title">2026å¹´01æœˆ</div>
                <button id="next-month">&gt;</button>
            </div>
            <select id="year-select" class="year-select">
                <option value="2025">2025</option>
                <option value="2026" selected>2026</option>
                <option value="2027">2027</option>
            </select>
        </div>
        <div class="weekdays">
            <div class="weekday sun">æ—¥</div>
            <div class="weekday">ä¸€</div>
            <div class="weekday">äºŒ</div>
            <div class="weekday">ä¸‰</div>
            <div class="weekday">å››</div>
            <div class="weekday">äº”</div>
            <div class="weekday">å…­</div>
        </div>
        <div class="days" id="days-container"></div>
        <button class="btn-save" id="save-calendar">å„²å­˜æœ¬æœˆæ’ç­</button>
    </div>

    <!-- ç­æ¬¡ç®¡ç†é é¢ -->
    <div class="container" id="shift-manage">
        <div class="manage-header">ç­æ¬¡ç®¡ç† | æ–°å¢/ç·¨è¼¯/åˆªé™¤</div>
        <form class="manage-form" id="shift-form">
            <div class="form-item">
                <label for="shift-code">ç­æ¬¡ç¨‹å¼ï¼ˆå¦‚D11Hã€Lï¼‰</label>
                <input type="text" id="shift-code" class="form-input" placeholder="è«‹è¼¸å…¥ç­æ¬¡ç¨‹å¼" required>
            </div>
            <div class="form-item">
                <label for="shift-time">ä¸Šä¸‹ç­æ™‚é–“ï¼ˆå¦‚11:30 - 19:00ã€æ”¾å‡ï¼‰</label>
                <input type="text" id="shift-time" class="form-input" placeholder="è«‹è¼¸å…¥æ™‚é–“/å‚™è¨»" required>
            </div>
            <div class="form-item">
                <label for="shift-color">é¸æ“‡ç­æ¬¡é…è‰²</label>
                <select id="shift-color" class="form-input" required>
                    <option value="" selected disabled>è«‹é¸æ“‡é…è‰²</option>
                    <option value="holiday">æ”¾å‡ - æ·ºå•¡è‰²</option>
                    <option value="morning">æ—©æ›´ - ç²‰ç´…è‰²</option>
                    <option value="noon">åˆé–“ - æ·±å•¡è‰²</option>
                    <option value="night">æ™šæ›´ - æ·±è—è‰²</option>
                    <option value="other">å…¶ä»– - æ·ºç¶ è‰²</option>
                </select>
            </div>
            <button type="submit" class="btn-add" id="btn-add-shift">æ–°å¢ç­æ¬¡</button>
        </form>
        <div class="shift-list" id="shift-list"></div>
        <button class="btn-save btn-save-shifts" id="save-shifts">å„²å­˜æ‰€æœ‰ç­æ¬¡</button>
    </div>

    <!-- åœ°é»ç®¡ç†é é¢ -->
    <div class="container" id="location-manage">
        <div class="manage-header">åœ°é»ç®¡ç† | æ–°å¢/ç·¨è¼¯/åˆªé™¤ï¼ˆé»˜èªKTï¼‰</div>
        <form class="manage-form" id="location-form">
            <div class="form-item">
                <label for="location-code">åœ°é»ç°¡å¯«ï¼ˆå¦‚KTã€TSTï¼‰</label>
                <input type="text" id="location-code" class="form-input" placeholder="è«‹è¼¸å…¥2-3å€‹å­—ç°¡å¯«" required>
            </div>
            <div class="form-item">
                <label for="location-desc">åœ°é»å…¨åï¼ˆå¦‚è§€å¡˜ã€å°–æ²™å’€ï¼‰</label>
                <input type="text" id="location-desc" class="form-input" placeholder="è«‹è¼¸å…¥åœ°é»å…¨å" required>
            </div>
            <button type="submit" class="btn-add" id="btn-add-location">æ–°å¢åœ°é»</button>
        </form>
        <div class="location-list" id="location-list"></div>
        <button class="btn-save btn-save-locations" id="save-locations">å„²å­˜æ‰€æœ‰åœ°é»</button>
    </div>

    <script>
        // å…¨å±€è®Šé‡ - é»˜èªè³¦å€¼ç‚ºç•¶å‰æœˆä»½ï¼ˆè§£æ±ºé–‹å•Ÿé»˜èªäºŒæœˆå•é¡Œï¼‰
        let today = new Date();
        let currentYear = today.getFullYear();
        let currentMonth = today.getMonth(); // ç›´æ¥å–ç•¶å‰æœˆä»½ç´¢å¼•ï¼ˆ0=1æœˆã€1=2æœˆ...ï¼‰
        const todayMonth = today.getMonth();
        const todayDate = today.getDate();
        let shiftTimes = {}; // ç­æ¬¡æ•¸æ“š {ä»£ç¢¼: {time, color}}
        let locations = {};  // åœ°é»æ•¸æ“š {ç°¡å¯«: å…¨å}
        let editShiftCode = null; // ç·¨è¼¯ç­æ¬¡æ¨™è¨˜
        let editLocCode = null;   // ç·¨è¼¯åœ°é»æ¨™è¨˜

        // é é¢åˆå§‹åŒ–
        function initApp() {
            // åŠ è¼‰ç­æ¬¡æ•¸æ“š
            const savedShifts = localStorage.getItem('shiftTimes');
            if (savedShifts) {
                shiftTimes = JSON.parse(savedShifts);
            } else {
                // é»˜èªç­æ¬¡æ•¸æ“š
                shiftTimes = {
                    "B**": {time: "06:00 - 15:30", color: "morning"},
                    "B6": {time: "06:00 - 13:30", color: "morning"},
                    "B": {time: "07:00 - 15:30", color: "morning"},
                    "B7": {time: "07:00 - 14:30", color: "morning"},
                    "B8": {time: "08:00 - 15:30", color: "morning"},
                    "B8H": {time: "08:30 - 16:00", color: "morning"},
                    "BB": {time: "06:00 - 15:30", color: "morning"},
                    "K/DD": {time: "08:45 - 17:33", color: "noon"},
                    "D845": {time: "08:45 - 16:15", color: "noon"},
                    "D8H": {time: "08:30 - 16:00", color: "noon"},
                    "D9": {time: "09:00 - 16:30", color: "noon"},
                    "D9H": {time: "09:30 - 17:00", color: "noon"},
                    "D10": {time: "10:00 - 17:30", color: "noon"},
                    "D10H": {time: "10:30 - 18:00", color: "noon"},
                    "D11": {time: "11:00 - 18:30", color: "noon"},
                    "D11H": {time: "11:30 - 19:00", color: "noon"},
                    "D12": {time: "12:00 - 19:30", color: "noon"},
                    "D12H": {time: "12:30 - 20:00", color: "noon"},
                    "E": {time: "14:30 - 23:00", color: "night"},
                    "E**": {time: "14:30 - 24:00", color: "night"},
                    "E1": {time: "13:00 - 20:30", color: "night"},
                    "E1H": {time: "13:30 - 21:00", color: "night"},
                    "E2": {time: "14:00 - 21:30", color: "night"},
                    "E2H": {time: "14:30 - 22:00", color: "night"},
                    "E3": {time: "15:00 - 22:30", color: "night"},
                    "E3H": {time: "15:30 - 23:00", color: "night"},
                    "E4": {time: "16:00 - 23:30", color: "night"},
                    "E4H": {time: "16:30 - 24:00", color: "night"},
                    "EE": {time: "14:30 - 23:00", color: "night"},
                    "L": {time: "æ”¾å‡", color: "holiday"},
                    "KCTA": {time: "23:00 - 07:30", color: "other"},
                };
            }

            // åŠ è¼‰åœ°é»æ•¸æ“š - é»˜èªKTï¼ˆå•Ÿå¾·ï¼‰ã€TSTï¼ˆå°–æ²™å’€ï¼‰
            const savedLocs = localStorage.getItem('locations');
            if (savedLocs) {
                locations = JSON.parse(savedLocs);
            } else {
                locations = {
                    "KT": "å•Ÿå¾·",
                    "TST": "å°–æ²™å’€"
                };
            }

            // æ¸²æŸ“æ‰€æœ‰æ¨¡å¡Š - ç›´æ¥æ¸²æŸ“ç•¶å‰æœˆä»½
            renderCalendar(currentYear, currentMonth);
            renderShiftList();
            renderLocationList();
        }

        // é é¢åˆ‡æ›
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const tab = btn.dataset.tab;
                document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
                document.getElementById(tab).classList.add('active');
                if (tab === 'calendar') renderCalendar(currentYear, currentMonth);
            });
        });

        // ç”Ÿæˆçµ±ä¸€çš„å„²å­˜KEYï¼ˆå¹´-æœˆè£œ0ï¼Œå¦‚2026-01ã€2026-12ï¼‰
        function getStorageKey(year, month) {
            const showMonth = month + 1;
            const fixedMonth = showMonth.toString().padStart(2, '0');
            return `shift_${year}-${fixedMonth}`;
        }

        // æ¸²æŸ“æœˆæ›† - é–‹å•Ÿå³é¡¯ç¤ºç•¶å‰æœˆä»½
        function renderCalendar(year, month) {
            const daysContainer = document.getElementById('days-container');
            daysContainer.innerHTML = '';

            const firstDay = new Date(year, month, 1).getDay(); // ç•¶æœˆ1è™Ÿæ˜ŸæœŸå¹¾
            const daysInMonth = new Date(year, month + 1, 0).getDate(); // ç•¶æœˆç¸½å¤©æ•¸
            const showMonth = month + 1;
            const fixedMonth = showMonth.toString().padStart(2, '0');
            // æ›´æ–°æ¨™é¡Œç‚ºç•¶å‰æœˆä»½ï¼ˆè£œ0æ ¼å¼ï¼‰
            document.getElementById('month-title').textContent = `${year}å¹´${fixedMonth}æœˆ`;
            document.getElementById('year-select').value = year;

            // å¡«å……ä¸Šæœˆç©ºç™½æ ¼
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.classList.add('day', 'empty');
                daysContainer.appendChild(emptyDay);
            }

            // ç­æ¬¡æ’åº
            const sortedShiftCodes = Object.keys(shiftTimes).sort((a, b) => a.localeCompare(b, 'zh-CN', { numeric: true }));
            let shiftOptions = '<option value="" selected disabled></option>';
            sortedShiftCodes.forEach(shift => {
                shiftOptions += `<option value="${shift}">${shift}</option>`;
            });

            // åŠ è¼‰ç•¶æœˆå„²å­˜çš„æ•¸æ“š
            const storageKey = getStorageKey(year, month);
            const savedCalendar = localStorage.getItem(storageKey);
            const calendarData = savedCalendar ? JSON.parse(savedCalendar) : {};

            // å¡«å……ç•¶æœˆæ—¥æœŸ
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.classList.add('day');
                // éæœŸåˆ¤æ–·ï¼ˆç•¶å‰æ—¥æœŸä¹‹å‰çš„æ—¥æœŸç¦ç”¨ï¼‰
                const isExpired = (year < currentYear) || 
                                  (year === currentYear && month < todayMonth) || 
                                  (year === currentYear && month === todayMonth && day < todayDate);
                if (isExpired) dayEl.classList.add('expired');

                // æ—¥æœŸæ¡†DOM - ç„¡é‡è¤‡TSTï¼Œåƒ…ä¸€å€‹åœ°é»æŒ‰éˆ•
                dayEl.innerHTML = `
                    <div class="date">${day}</div>
                    <select class="shift-select">${shiftOptions}</select>
                    <div class="shift-info"></div>
                    <button class="loc-btn">KT</button>
                `;
                daysContainer.appendChild(dayEl);

                // åŠ è¼‰å„²å­˜çš„ç­æ¬¡+åœ°é»ç‹€æ…‹
                if (calendarData[day]) {
                    const { shiftCode, locCode } = calendarData[day];
                    const select = dayEl.querySelector('.shift-select');
                    const infoEl = dayEl.querySelector('.shift-info');
                    const locBtn = dayEl.querySelector('.loc-btn');
                    
                    // åŠ è¼‰ç­æ¬¡
                    if (shiftCode) {
                        select.value = shiftCode;
                        const {time, color} = shiftTimes[shiftCode];
                        dayEl.classList.add(`bg-${color}`);
                        const codeClass = (shiftCode === 'BB' || shiftCode === 'EE') ? 's-code blue' : 's-code';
                        infoEl.innerHTML = `<span class="${codeClass}">${shiftCode}</span><span class="s-time">${time}</span>`;
                    }

                    // åŠ è¼‰åœ°é»ç‹€æ…‹ï¼ˆTSTæ¿€æ´»ï¼ŒKTé»˜èªï¼‰
                    if (locCode === 'TST') {
                        locBtn.classList.add('active');
                        locBtn.textContent = 'TST';
                    }
                }

                // ç¶å®šäº‹ä»¶
                dayEl.querySelector('.shift-select').addEventListener('change', updateShiftInfo);
                dayEl.querySelector('.loc-btn').addEventListener('click', function() {
                    this.classList.toggle('active');
                    this.textContent = this.classList.contains('active') ? 'TST' : 'KT';
                });
            }
        }

        // æ›´æ–°ç­æ¬¡ä¿¡æ¯
        function updateShiftInfo() {
            const code = this.value;
            const infoEl = this.nextElementSibling;
            const dayEl = this.parentElement;
            dayEl.classList.remove('bg-holiday', 'bg-morning', 'bg-noon', 'bg-night', 'bg-other');

            if (!code) {
                infoEl.innerHTML = '';
                return;
            }
            const {time, color} = shiftTimes[code];
            dayEl.classList.add(`bg-${color}`);
            const codeClass = (code === 'BB' || code === 'EE') ? 's-code blue' : 's-code';
            infoEl.innerHTML = `<span class="${codeClass}">${code}</span><span class="s-time">${time}</span>`;
        }

        // æœˆä»½åˆ‡æ›
        document.getElementById('prev-month').addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar(currentYear, currentMonth);
        });
        document.getElementById('next-month').addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar(currentYear, currentMonth);
        });
        // å¹´ä»½é¸æ“‡å™¨
        document.getElementById('year-select').addEventListener('change', (e) => {
            currentYear = parseInt(e.target.value);
            renderCalendar(currentYear, currentMonth);
        });

        // ä¿å­˜æœ¬æœˆæ’ç­ - æ ¸å¿ƒï¼šå½ˆçª—é¡¯ç¤ºè©³ç´°å„²å­˜è³‡è¨Š
        document.getElementById('save-calendar').addEventListener('click', () => {
            const storageKey = getStorageKey(currentYear, currentMonth);
            const saveData = {};
            let saveInfo = `âœ… ${currentYear}å¹´${currentMonth+1}æœˆæ’ç­å„²å­˜æˆåŠŸï¼\n\nå·²å„²å­˜æ’ç­ï¼š\n`;
            let hasData = false;

            document.querySelectorAll('.day').forEach(dayEl => {
                const date = dayEl.querySelector('.date')?.textContent;
                if (!date) return; // è·³éç©ºç™½æ ¼
                const shiftCode = dayEl.querySelector('.shift-select')?.value;
                const locBtn = dayEl.querySelector('.loc-btn');
                const locCode = locBtn.classList.contains('active') ? 'TST' : 'KT';
                const locName = locations[locCode] || locCode; // é¡¯ç¤ºåœ°é»å…¨å
                
                saveData[date] = { shiftCode, locCode };
                // åªæ”¶é›†æœ‰ç­æ¬¡çš„æ•¸æ“šé¡¯ç¤º
                if (shiftCode) {
                    hasData = true;
                    const shiftTime = shiftTimes[shiftCode].time;
                    saveInfo += `ğŸ“… ${date}æ—¥ | ğŸ•’ ${shiftCode}(${shiftTime}) | ğŸ“ ${locCode}(${locName})\n`;
                }
            });

            // å„²å­˜åˆ°æœ¬åœ°
            localStorage.setItem(storageKey, JSON.stringify(saveData));
            // å½ˆçª—æç¤ºï¼ˆç„¡ç­æ¬¡æ™‚é¡¯ç¤ºåŸºç¤æç¤ºï¼Œæœ‰ç­æ¬¡é¡¯ç¤ºè©³æƒ…ï¼‰
            alert(hasData ? saveInfo : `âœ… ${currentYear}å¹´${currentMonth+1}æœˆæ’ç­å„²å­˜æˆåŠŸï¼\nç•¶æœˆæš«ç„¡è¨­å®šç­æ¬¡ï½`);
        });

        // ---------------------- ç­æ¬¡ç®¡ç†åŠŸèƒ½ ----------------------
        function renderShiftList() {
            const listContainer = document.getElementById('shift-list');
            listContainer.innerHTML = '';
            const sortedShifts = Object.entries(shiftTimes).sort((a, b) => a[0].localeCompare(b, 'zh-CN', { numeric: true }));
            const colorName = {
                holiday: 'æ”¾å‡-æ·ºå•¡',
                morning: 'æ—©æ›´-ç²‰ç´…',
                noon: 'åˆé–“-æ·±å•¡',
                night: 'æ™šæ›´-æ·±è—',
                other: 'å…¶ä»–-æ·ºç¶ '
            };
            sortedShifts.forEach(([code, {time, color}]) => {
                const item = document.createElement('div');
                item.className = `shift-item bg-${color}`;
                item.innerHTML = `
                    <div class="shift-item-info">
                        <span class="shift-item-code">${code}</span>
                        <span class="shift-item-time">${time}</span>
                        <span class="shift-item-color">é…è‰²ï¼š${colorName[color]}</span>
                    </div>
                    <div class="shift-actions">
                        <button class="btn-edit" data-code="${code}">ç·¨è¼¯</button>
                        <button class="btn-delete" data-code="${code}">åˆªé™¤</button>
                    </div>
                `;
                listContainer.appendChild(item);
            });
            bindShiftActions();
        }

        function bindShiftActions() {
            // ç·¨è¼¯ç­æ¬¡
            document.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const code = e.target.dataset.code;
                    const {time, color} = shiftTimes[code];
                    editShiftCode = code;
                    document.getElementById('shift-code').value = code;
                    document.getElementById('shift-time').value = time;
                    document.getElementById('shift-color').value = color;
                    document.getElementById('btn-add-shift').textContent = 'ä¿å­˜ç·¨è¼¯';
                });
            });
            // åˆªé™¤ç­æ¬¡
            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const code = e.target.dataset.code;
                    if (confirm(`ç¢ºå®šåˆªé™¤ç­æ¬¡ã€${code}ã€‘å—ï¼Ÿ`)) {
                        delete shiftTimes[code];
                        renderShiftList();
                    }
                });
            });
        }

        // æ–°å¢/ç·¨è¼¯ç­æ¬¡æäº¤
        document.getElementById('shift-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const code = document.getElementById('shift-code').value.trim();
            const time = document.getElementById('shift-time').value.trim();
            const color = document.getElementById('shift-color').value;
            if (!code || !time) return;

            if (editShiftCode) {
                delete shiftTimes[editShiftCode];
                shiftTimes[code] = {time, color};
                editShiftCode = null;
                document.getElementById('btn-add-shift').textContent = 'æ–°å¢ç­æ¬¡';
                alert(`âœ… ç­æ¬¡ã€${code}ã€‘å·²ç·¨è¼¯ï¼`);
            } else {
                if (shiftTimes[code]) {
                    alert(`âš ï¸ ç­æ¬¡ã€${code}ã€‘å·²å­˜åœ¨ï¼`);
                    return;
                }
                shiftTimes[code] = {time, color};
                alert(`âœ… ç­æ¬¡ã€${code}ã€‘å·²æ–°å¢ï¼`);
            }
            document.getElementById('shift-form').reset();
            renderShiftList();
        });

        // ä¿å­˜æ‰€æœ‰ç­æ¬¡
        document.getElementById('save-shifts').addEventListener('click', () => {
            localStorage.setItem('shiftTimes', JSON.stringify(shiftTimes));
            // å½ˆçª—é¡¯ç¤ºç­æ¬¡æ•¸é‡
            alert(`âœ… æ‰€æœ‰ç­æ¬¡å·²å„²å­˜åˆ°æœ¬åœ°ï¼\nç•¶å‰å…±å„²å­˜ ${Object.keys(shiftTimes).length} å€‹ç­æ¬¡ï½`);
        });

        // ---------------------- åœ°é»ç®¡ç†åŠŸèƒ½ ----------------------
        function renderLocationList() {
            const listContainer = document.getElementById('location-list');
            listContainer.innerHTML = '';
            const sortedLocs = Object.entries(locations).sort((a, b) => a[0].localeCompare(b));
            sortedLocs.forEach(([code, desc]) => {
                const item = document.createElement('div');
                item.className = `location-item ${code === 'KT' ? 'active-loc' : ''}`;
                item.innerHTML = `
                    <div class="location-item-info">
                        <span class="location-item-code">${code}</span>
                        <span class="location-item-desc">${desc}</span>
                        ${code === 'KT' ? '<span style="font-size:12px;color:#ff9800;">é»˜èªåœ°é»</span>' : ''}
                    </div>
                    <div class="location-actions">
                        <button class="loc-btn-edit" data-code="${code}">ç·¨è¼¯</button>
                        <button class="loc-btn-delete" data-code="${code}" ${code === 'KT' ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}>åˆªé™¤</button>
                    </div>
                `;
                listContainer.appendChild(item);
            });
            bindLocationActions();
        }

        function bindLocationActions() {
            // ç·¨è¼¯åœ°é»
            document.querySelectorAll('.loc-btn-edit').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const code = e.target.dataset.code;
                    const desc = locations[code];
                    editLocCode = code;
                    document.getElementById('location-code').value = code;
                    document.getElementById('location-desc').value = desc;
                    document.getElementById('btn-add-location').textContent = 'ä¿å­˜ç·¨è¼¯';
                });
            });
            // åˆªé™¤åœ°é»ï¼ˆKTä¸å¯åˆªï¼‰
            document.querySelectorAll('.loc-btn-delete').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const code = e.target.dataset.code;
                    if (code === 'KT') return;
                    if (confirm(`ç¢ºå®šåˆªé™¤åœ°é»ã€${code} - ${locations[code]}ã€‘å—ï¼Ÿ`)) {
                        delete locations[code];
                        renderLocationList();
                    }
                });
            });
        }

        // æ–°å¢/ç·¨è¼¯åœ°é»æäº¤
        document.getElementById('location-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const code = document.getElementById('location-code').value.trim().toUpperCase();
            const desc = document.getElementById('location-desc').value.trim();
            if (!code || !desc || code.length > 3) {
                alert('âš ï¸ ç°¡å¯«é™2-3å€‹å­—ï¼Œå…¨åä¸å¯ç‚ºç©ºï¼');
                return;
            }

            if (editLocCode) {
                // KTä¸å¯ä¿®æ”¹ç°¡å¯«
                if (editLocCode === 'KT' && code !== 'KT') {
                    alert('âš ï¸ é»˜èªåœ°é»KTçš„ç°¡å¯«ä¸å¯ä¿®æ”¹ï¼');
                    return;
                }
                delete locations[editLocCode];
                locations[code] = desc;
                editLocCode = null;
                document.getElementById('btn-add-location').textContent = 'æ–°å¢åœ°é»';
                alert(`âœ… åœ°é»ã€${code} - ${desc}ã€‘å·²ç·¨è¼¯ï¼`);
            } else {
                if (locations[code]) {
                    alert(`âš ï¸ åœ°é»ã€${code}ã€‘å·²å­˜åœ¨ï¼`);
                    return;
                }
                locations[code] = desc;
                alert(`âœ… åœ°é»ã€${code} - ${desc}ã€‘å·²æ–°å¢ï¼`);
            }
            document.getElementById('location-form').reset();
            renderLocationList();
        });

        // ä¿å­˜æ‰€æœ‰åœ°é»
        document.getElementById('save-locations').addEventListener('click', () => {
            localStorage.setItem('locations', JSON.stringify(locations));
            // å½ˆçª—é¡¯ç¤ºåœ°é»æ•¸é‡
            alert(`âœ… æ‰€æœ‰åœ°é»å·²å„²å­˜åˆ°æœ¬åœ°ï¼\nç•¶å‰å…±å„²å­˜ ${Object.keys(locations).length} å€‹åœ°é»ï½`);
        });

        // åˆå§‹åŒ–æ‡‰ç”¨ - æ‰“é–‹å³è¼‰å…¥ç•¶å‰æœˆä»½
        window.onload = initApp;
    </script>
</body>
</html>

