<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>毛毛排班月曆</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background-color: #fff8f0;
            padding: 15px;
            min-height: 100vh;
        }
        /* 頁面切換按鈕 */
        .page-tabs {
            max-width: 600px;
            margin: 0 auto 15px;
            display: flex;
            gap: 10px;
        }
        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            background: #ffb74d;
            color: white;
        }
        .tab-btn.active {
            background: #8c6d53;
            box-shadow: 0 2px 8px rgba(255,167,38,0.3);
        }
        .tab-btn:hover {
            background: #8c6d53;
        }
        /* 通用容器 */
        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            overflow: hidden;
            max-width: 600px;
            margin: 0 auto;
            display: none;
        }
        .container.active {
            display: block;
        }
        /* 月曆頁面樣式 - 所有月份完全統一 */
        .calendar-header {
            background-color: #ffb74d;
            color: white;
            padding: 18px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .month-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            justify-content: center;
        }
        .month-selector button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .month-selector button:hover {
            background: rgba(255,255,255,0.3);
        }
        .month-title {
            font-size: 19px;
            font-weight: bold;
            text-align: center;
            margin: 0 10px;
        }
        .year-select {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 8px;
            border-radius: 6px;
            font-size: 13px;
            outline: none;
        }
        .year-select option {
            color: #333;
        }
        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background-color: #fff3e0;
            border-bottom: 1px solid #ffe0b2;
        }
        .weekday {
            padding: 10px 0;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            color: #f57c00;
        }
        .weekday.sun {
            color: #e53935; /* 周日紅色 */
        }
        /* 核心：固定高度，內容不溢出 */
        .days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            padding: 12px;
            grid-auto-rows: 115px;
        }
        /* 日期框：整框配色，默認色，溢出隱藏 */
        .day {
            border-radius: 8px;
            padding: 7px 5px;
            border: 1px solid #ffe0b2;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            gap: 7px;
            background: #fff8f0;
            overflow: hidden;
        }
        /* 時段配色 - 整框應用 */
        .day.bg-holiday { background: #f5e9d7; border-color: #e8d4b9; } /* 放假淺啡 */
        .day.bg-morning { background: #fce4ec; border-color: #f8bbd0; } /* 早更粉紅 */
        .day.bg-noon { background: #e8d9c8; border-color: #d2b48c; }   /* 午間深啡 */
        .day.bg-night { background: #e3eaf5; border-color: #bdd0eb; }  /* 晚間深藍 */
        .day.bg-other { background: #e8f5e9; border-color: #c8e6c9; }  /* 其他淺綠 */
        .day:hover {
            border-color: #ffb74d;
            transform: translateY(-1px);
        }
        .day.empty {
            background: transparent;
            border: none;
        }
        .day.expired { /* 過期色強制覆蓋 */
            background: #f5f5f5 !important;
            border-color: #e0e0e0 !important;
            opacity: 0.6;
            pointer-events: none;
            overflow: hidden;
        }
        .date {
            font-size: 15px;
            font-weight: bold;
            color: #f57c00;
            text-align: center;
            line-height: 1;
            flex-shrink: 0;
        }
        .shift-select {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 5px 3px;
            text-align: center;
            font-size: 13px;
            background: rgba(255,255,255,0.9);
            transition: all 0.2s;
            outline: none;
            color: #333;
            flex-shrink: 0;
        }
        .shift-select:focus {
            border-color: #ffb74d;
            background: #fff;
        }
        /* 班次信息：移除分隔符，班次粗體區分時間 */
        .shift-info {
            font-size: 11px;
            color: #333;
            text-align: center;
            line-height: 1.5;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 4px;
            word-wrap: break-word;
            white-space: normal;
        }
        .s-code {
            font-weight: 700; /* 班次粗體核心 */
            font-size: 12px;
        }
        .s-time {
            font-weight: 400;
        }
        /* 按鈕樣式 */
        .btn-save {
            display: block;
            width: 90%;
            margin: 15px auto 20px;
            padding: 12px;
            background: #ffb74d;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn-save:hover {
            background: #8c6d53;
        }
        /* 班次管理頁面 - 新增配色選擇器，樣式優化 */
        .manage-header {
            background-color: #ffb74d;
            color: white;
            padding: 20px 15px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
        }
        .manage-form {
            padding: 20px 15px;
            border-bottom: 1px solid #ffe0b2;
            display: grid;
            gap: 15px;
            grid-template-columns: 1fr 1fr;
        }
        .manage-form .form-item {
            grid-column: span 2;
        }
        .manage-form .color-item {
            grid-column: span 2;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .form-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .form-item label, .color-item label {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }
        .form-input, .color-select {
            padding: 10px;
            border: 1px solid #ffe0b2;
            border-radius: 8px;
            outline: none;
            font-size: 14px;
            color: #333;
        }
        .form-input:focus, .color-select:focus {
            border-color: #ffb74d;
        }
        .btn-add {
            grid-column: span 2;
            padding: 12px;
            background: #ffb74d;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn-add:hover {
            background: #8c6d53;
        }
        .shift-list {
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        .shift-item {
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 10px;
            min-height: 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            border: 1px solid #eee;
        }
        .shift-item.bg-holiday { background: #f5e9d7; border-color: #e8d4b9; }
        .shift-item.bg-morning { background: #fce4ec; border-color: #f8bbd0; }
        .shift-item.bg-noon { background: #e8d9c8; border-color: #d2b48c; }
        .shift-item.bg-night { background: #e3eaf5; border-color: #bdd0eb; }
        .shift-item.bg-other { background: #e8f5e9; border-color: #c8e6c9; }
        .shift-item-info {
            display: flex;
            flex-direction: column;
            gap: 3px;
            align-items: flex-start;
            flex-grow: 1;
        }
        .shift-item-code {
            font-size: 16px;
            font-weight: 700;
            color: #333;
        }
        .shift-item-time {
            font-size: 13px;
            color: #666;
        }
        .shift-item-color {
            font-size: 12px;
            color: #888;
        }
        .shift-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }
        .btn-edit, .btn-delete {
            padding: 5px 10px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-edit {
            background: #e3f2fd;
            color: #2196f3;
        }
        .btn-edit:hover {
            background: #bbdefb;
        }
        .btn-delete {
            background: #ffebee;
            color: #e53935;
        }
        .btn-delete:hover {
            background: #ffcdd2;
        }
        .btn-save-shifts {
            margin: 15px;
        }
        /* 手機小屏適配 */
        @media (max-width: 450px) {
            .days {
                gap: 4px;
                padding: 10px;
                grid-auto-rows: 110px;
            }
            .day {
                padding: 6px 4px;
                gap: 6px;
            }
            .date {
                font-size: 14px;
            }
            .shift-select {
                font-size: 12px;
                padding: 4px 2px;
            }
            .shift-info {
                font-size: 10px;
                gap: 3px;
            }
            .s-code {
                font-size: 11px;
            }
            .weekday {
                padding: 8px 0;
                font-size: 12px;
            }
            .tab-btn {
                padding: 10px;
                font-size: 15px;
            }
            .shift-item {
                padding: 10px 12px;
                gap: 10px;
            }
            .shift-item-code {
                font-size: 15px;
            }
        }
        /* 超小屏保險 */
        @media (max-width: 380px) {
            .days {
                grid-auto-rows: 105px;
            }
            .shift-info {
                font-size: 9.5px;
            }
        }
    </style>
</head>
<body>
    <!-- 頁面切換按鈕 -->
    <div class="page-tabs">
        <button class="tab-btn active" data-tab="calendar">排班月曆</button>
        <button class="tab-btn" data-tab="manage">班次管理</button>
    </div>

    <!-- 排班月曆頁面 -->
    <div class="container active" id="calendar">
        <div class="calendar-header">
            <div class="month-selector">
                <button id="prev-month">&lt;</button>
                <div class="month-title" id="month-title">2026年2月</div>
                <button id="next-month">&gt;</button>
            </div>
            <select id="year-select" class="year-select">
                <option value="2025">2025</option>
                <option value="2026" selected>2026</option>
                <option value="2027">2027</option>
            </select>
        </div>
        <div class="weekdays">
            <div class="weekday sun">日</div>
            <div class="weekday">一</div>
            <div class="weekday">二</div>
            <div class="weekday">三</div>
            <div class="weekday">四</div>
            <div class="weekday">五</div>
            <div class="weekday">六</div>
        </div>
        <div class="days" id="days-container"></div>
        <button class="btn-save" id="save-calendar">儲存本月排班</button>
    </div>

    <!-- 班次管理頁面 - 新增配色選擇器 -->
    <div class="container" id="manage">
        <div class="manage-header">班次管理 | 新增/編輯/刪除</div>
        <form class="manage-form" id="shift-form">
            <div class="form-item">
                <label for="shift-code">班次程式（如D11H、L）</label>
                <input type="text" id="shift-code" class="form-input" placeholder="請輸入班次程式" required>
            </div>
            <div class="form-item">
                <label for="shift-time">上下班時間（如11:30 - 19:00、放假）</label>
                <input type="text" id="shift-time" class="form-input" placeholder="請輸入時間/備註" required>
            </div>
            <!-- 新增：手動選擇時段配色 -->
            <div class="color-item">
                <label for="shift-color">選擇班次配色</label>
                <select id="shift-color" class="color-select" required>
                    <option value="" selected disabled>請選擇配色</option>
                    <option value="holiday">放假 - 淺啡色</option>
                    <option value="morning">早更 - 粉紅色</option>
                    <option value="noon">午間 - 深啡色</option>
                    <option value="night">晚更 - 深藍色</option>
                    <option value="other">其他 - 淺綠色</option>
                </select>
            </div>
            <button type="submit" class="btn-add" id="btn-add-shift">新增班次</button>
        </form>
        <div class="shift-list" id="shift-list"></div>
        <button class="btn-save btn-save-shifts" id="save-shifts">儲存所有班次</button>
    </div>

    <script>
        // 全局變量
        let currentYear = 2026;
        let currentMonth = 1; // 0=1月,1=2月...
        const today = new Date();
        const todayYear = today.getFullYear();
        const todayMonth = today.getMonth();
        const todayDate = today.getDate();
        let shiftTimes = {}; // 存儲班次：{code: {time: '', color: ''}}
        let editCode = null;

        // 頁面初始化
        function initApp() {
            const today = new Date();
            currentYear = today.getFullYear(); // 獲取當前年份
            currentMonth = today.getMonth();

            const savedShifts = localStorage.getItem('shiftTimes');
            if (savedShifts) {
                shiftTimes = JSON.parse(savedShifts);
            } else {
                // 默認班次數據（帶配色）
                shiftTimes = {
                    "B**": {time: "06:00 - 15:30", color: "morning"},
                    "B6": {time: "06:00 - 13:30", color: "morning"},
                    "B": {time: "07:00 - 15:30", color: "morning"},
                    "B7": {time: "07:00 - 14:30", color: "morning"},
                    "B8": {time: "08:00 - 15:30", color: "morning"},
                    "B8H": {time: "08:30 - 16:00", color: "morning"},
                    "BB": {time: "06:00 - 15:30", color: "morning"},

                    "K/DD": {time: "08:45 - 17:33", color: "noon"},
                    "D845": {time: "08:45 - 16:15", color: "noon"},
                    "D8H": {time: "08:30 - 16:00", color: "noon"},
                    "D9": {time: "09:00 - 16:30", color: "noon"},
                    "D9H": {time: "09:30 - 17:00", color: "noon"},
                    "D10": {time: "10:00 - 17:30", color: "noon"},
                    "D10H": {time: "10:30 - 18:00", color: "noon"},
                    "D11": {time: "11:00 - 18:30", color: "noon"},
                    "D11H": {time: "11:30 - 19:00", color: "noon"},
                    "D12": {time: "12:00 - 19:30", color: "noon"},
                    "D12H": {time: "12:30 - 20:00", color: "noon"},

                    "E": {time: "14:30 - 23:00", color: "night"},
                    "E**": {time: "14:30 - 24:00", color: "night"},
                    "E1": {time: "13:00 - 20:30", color: "night"},
                    "E1H": {time: "13:30 - 21:00", color: "night"},
                    "E2": {time: "14:00 - 21:30", color: "night"},
                    "E2H": {time: "14:30 - 22:00", color: "night"},
                    "E3": {time: "15:00 - 22:30", color: "night"},
                    "E3H": {time: "15:30 - 23:00", color: "night"},
                    "E4": {time: "16:00 - 23:30", color: "night"},
                    "E4H": {time: "16:30 - 24:00", color: "night"},
                    "EE": {time: "14:30 - 23:00", color: "night"},

                    "L": {time: "放假", color: "holiday"},
                    "KCTA": {time: "23:00 - 07:30", color: "other"},
                };
            }
            renderCalendar(currentYear, currentMonth);
            renderShiftList();
        }

        // 頁面切換
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const tab = btn.dataset.tab;
                document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
                document.getElementById(tab).classList.add('active');
                if (tab === 'calendar') renderCalendar(currentYear, currentMonth);
            });
        });

        // 渲染月曆 - 字母排序，整框配色，移除分隔符
        function renderCalendar(year, month) {
            const daysContainer = document.getElementById('days-container');
            daysContainer.innerHTML = '';

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // 填充上月空白格
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.classList.add('day', 'empty');
                daysContainer.appendChild(emptyDay);
            }

            // 班次按字母+數字自然排序
            const sortedShiftCodes = Object.keys(shiftTimes).sort((a, b) => a.localeCompare(b, 'zh-CN', { numeric: true }));
            let shiftOptions = '<option value="" selected disabled></option>';
            sortedShiftCodes.forEach(shift => {
                shiftOptions += `<option value="${shift}">${shift}</option>`;
            });

            // 填充當月日期
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.classList.add('day');
                // 過期判斷
                const isExpired = (year < todayYear) || 
                                  (year === todayYear && month < todayMonth) || 
                                  (year === todayYear && month === todayMonth && day < todayDate);
                if (isExpired) dayEl.classList.add('expired');

                // 固定DOM結構
                dayEl.innerHTML = `
                    <div class="date">${day}</div>
                    <select class="shift-select">${shiftOptions}</select>
                    <div class="shift-info"></div>
                `;
                daysContainer.appendChild(dayEl);

                // 加載保存的排班
                const saveKey = `shift_${year}-${month + 1}`;
                const savedCalendar = localStorage.getItem(saveKey);
                if (savedCalendar) {
                    const calendarData = JSON.parse(savedCalendar);
                    if (calendarData[day]) {
                        const select = dayEl.querySelector('.shift-select');
                        const infoEl = dayEl.querySelector('.shift-info');
                        const code = calendarData[day];
                        select.value = code;
                        const {time, color} = shiftTimes[code];
                        // 整框配色
                        dayEl.classList.add(`bg-${color}`);
                        // 移除分隔符，班次粗體
                        infoEl.innerHTML = `
                            <span class="s-code">${code}</span>
                            <span class="s-time">${time}</span>
                        `;
                    }
                }
            }

            // 綁定選擇事件
            document.querySelectorAll('.shift-select').forEach(select => {
                select.addEventListener('change', updateShiftInfo);
            });

            // 更新標題
            document.getElementById('month-title').textContent = `${year}年${month + 1}月`;
            document.getElementById('year-select').value = year;
        }

        // 更新班次信息 - 移除分隔符，粗體班次
        function updateShiftInfo() {
            const code = this.value;
            const infoEl = this.nextElementSibling;
            const dayEl = this.parentElement;
            // 清除原有配色
            dayEl.classList.remove('bg-holiday', 'bg-morning', 'bg-noon', 'bg-night', 'bg-other');

            if (!code) {
                infoEl.innerHTML = '';
                return;
            }
            const {time, color} = shiftTimes[code];
            // 整框配色
            dayEl.classList.add(`bg-${color}`);
            
            // 設置班次字體顏色
            if (code === 'BB' || code === 'EE') {
                infoEl.innerHTML = `
                    <span class="s-code" style="color: blue;">${code}</span>
                    <span class="s-time">${time}</span>
                `;
            } else {
                // 班次粗體，無分隔符
                infoEl.innerHTML = `
                    <span class="s-code">${code}</span>
                    <span class="s-time">${time}</span>
                `;
            }
        }


        // 月份切換
        document.getElementById('prev-month').addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar(currentYear, currentMonth);
        });
        document.getElementById('next-month').addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar(currentYear, currentMonth);
        });

        // 年份選擇
        document.getElementById('year-select').addEventListener('change', (e) => {
            currentYear = parseInt(e.target.value);
            renderCalendar(currentYear, currentMonth);
        });

        // 保存本月排班
        document.getElementById('save-calendar').addEventListener('click', () => {
            const saveKey = `${currentYear}-${currentMonth + 1}`;
            const saveData = {};
            document.querySelectorAll('.day').forEach(dayEl => {
                const date = dayEl.querySelector('.date')?.textContent;
                const shift = dayEl.querySelector('.shift-select')?.value;
                if (date && shift) saveData[date] = shift;
            });
            localStorage.setItem(`shift_${saveKey}`, JSON.stringify(saveData));
            alert("✅ 本月排班已儲存！");
        });

        // 渲染班次列表 - 顯示配色，支持手動選擇
        function renderShiftList() {
            const listContainer = document.getElementById('shift-list');
            listContainer.innerHTML = '';
            // 按字母排序
            const sortedShifts = Object.entries(shiftTimes).sort((a, b) => a[0].localeCompare(b, 'zh-CN', { numeric: true }));
            // 配色名對應
            const colorName = {
                holiday: '放假-淺啡',
                morning: '早更-粉紅',
                noon: '午間-深啡',
                night: '晚更-深藍',
                other: '其他-淺綠'
            };
            sortedShifts.forEach(([code, {time, color}]) => {
                const item = document.createElement('div');
                item.className = `shift-item bg-${color}`;
                item.dataset.code = code;
                item.innerHTML = `
                    <div class="shift-item-info">
                        <span class="shift-item-code">${code}</span>
                        <span class="shift-item-time">${time}</span>
                        <span class="shift-item-color">配色：${colorName[color]}</span>
                    </div>
                    <div class="shift-actions">
                        <button class="btn-edit" data-code="${code}">編輯</button>
                        <button class="btn-delete" data-code="${code}">刪除</button>
                    </div>
                `;
                listContainer.appendChild(item);
            });
            bindShiftActions();
        }

        // 綁定編輯/刪除事件 - 編輯帶配色回顯
        function bindShiftActions() {
            // 編輯班次
            document.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const code = e.target.dataset.code;
                    const {time, color} = shiftTimes[code];
                    editCode = code;
                    // 回顯數據
                    document.getElementById('shift-code').value = code;
                    document.getElementById('shift-time').value = time;
                    document.getElementById('shift-color').value = color;
                    document.getElementById('btn-add-shift').textContent = '保存編輯';
                });
            });
            // 刪除班次
            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const code = e.target.dataset.code;
                    if (confirm(`確定要刪除班次【${code}】嗎？`)) {
                        delete shiftTimes[code];
                        renderShiftList();
                    }
                });
            });
        }

        // 新增/編輯班次 - 處理手動選擇的配色
        document.getElementById('shift-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const code = document.getElementById('shift-code').value.trim();
            const time = document.getElementById('shift-time').value.trim();
            const color = document.getElementById('shift-color').value;
            if (!code || !time || !color) return;

            if (editCode) {
                // 編輯班次：刪除舊的，添加新的
                delete shiftTimes[editCode];
                shiftTimes[code] = {time, color};
                editCode = null;
                document.getElementById('btn-add-shift').textContent = '新增班次';
                alert(`✅ 班次【${code}】已編輯！`);
            } else {
                // 新增班次：判斷是否重複
                if (shiftTimes[code]) {
                    alert(`⚠️ 班次【${code}】已存在！`);
                    return;
                }
                shiftTimes[code] = {time, color};
                alert(`✅ 班次【${code}】已新增！`);
            }
            // 重置表單
            document.getElementById('shift-form').reset();
            renderShiftList();
        });

        // 儲存所有班次到伺服器
        document.getElementById('save-shifts').addEventListener('click', async () => {
            const shiftsToSave = {};
            for (const [code, { time, color }] of Object.entries(shiftTimes)) {
                shiftsToSave[code] = { time, color };
            }

            try {
                const response = await fetch('/.netlify/functions/saveShifts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ shifts: shiftsToSave })
                });

                if (response.ok) {
                    alert("✅ 所有班次已儲存到伺服器！");
                } else {
                    alert("❌ 儲存失敗，請稍後再試。");
                }
            } catch (error) {
                console.error(error);
                alert("❌ 發生錯誤，請稍後再試。");
            }
        });


        // 初始化應用
        window.onload = initApp;
    </script>
</body>
</html>